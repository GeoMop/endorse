flow123d_version: 3.9.1
problem: !Coupling_Sequential
  description: Model of tunnel surroundings relaxation after boring.
  mesh:
    mesh_file: Bukov_both_h100_31k.msh2
#    mesh_file: Bukov_both_h50_150k.msh2
  flow_equation: !Coupling_Iterative
    input_fields:
      - region: BULK
        biot_alpha: 0.2
        fluid_density: 1000
    time:
      end_time: 130
      # common time unit cannot be used in field formulas
      common_time_unit: d
    iteration_parameter: 1 # affects convergence of HM coupling (defaults to 1, lower value sometimes helps)
    a_tol: 0
    r_tol: 1e-6
    flow_equation: !Flow_Richards_LMH
        user_fields:
          - name: init_p
            scalar_field: 20
          - name: kr
            scalar_field: 8e-20
          - name: beta1
            scalar_field: 4e-7
          - name: deltakmax
            scalar_field: 8e-17
          - name: gamma
            scalar_field: 3e-7
          - name: stress_threshold
            scalar_field: 55e6
          - name: a # coefficient for nonhomogeneous conductivity (range: -1 to 1)
            scalar_field: 0
          - name: b # coefficient for nonhomogeneous conductivity (range: -1 to 1)
            scalar_field: 0
          - name: c # coefficient for nonhomogeneous conductivity (range: -1 to 1)
            scalar_field: 0
        nonlinear_solver:
          linear_solver: !Petsc
            a_tol: 0
            r_tol: 1e-12
            options: -ksp_type cg -pc_type hypre -pc_hypre_type boomeramg
        input_fields:
          - region: BULK
            conductivity: !FieldFormula
              value: if(von_mises_stress<stress_threshold,
                        1000*9.81/0.001 * (kr + deltakmax*exp(beta1 * mean_stress)),
                        1000*9.81/0.001 * (kr + deltakmax*exp(beta1 * mean_stress)) * exp(gamma*(von_mises_stress-stress_threshold))
                       )*(1 + a*x/35 + b*y/30 + c*z/30)
            # https://en.wikipedia.org/wiki/Specific_storage
            storativity: !FieldFormula   # S = rho * g * (beta_s + nu * beta_w)
              value: 9.81e3 * (3*(1-2*0.23)/60e9 + 0.007*5.1e-10)
            # bulk compressibility beta_s=1/K = (3(1-2pr)/E) 
            # porosity nu=0.007
            # water compressibility beta_w=5.1 1/Pa
            init_pressure: !FieldFormula
              value: init_p

          - region: .box_outer
            bc_type: dirichlet
            bc_pressure: !FieldFormula
              value: init_p

          - region: .box_tunnel
            time: 0
            bc_type: total_flux
            bc_pressure: !FieldFormula
              value: if((-x>2) | (x>2),init_p,0)
            bc_robin_sigma: !FieldFormula
              value: if((-x>2) | (x>2),0,1e3)
          - region: .box_tunnel
            time: 100
            bc_type: total_flux
            bc_pressure: !FieldFormula
              value: if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),init_p,0)
            bc_robin_sigma: !FieldFormula
              value: if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),0,1e3)
#          - region: .box_tunnel
#            time: 112
#            bc_type: dirichlet
#            bc_pressure: 0

        output:
          times: &output_times [{'begin': 0, 'step': 100, 'end': 100}, {'begin': 100, 'step': 1, 'end': 112}, {'begin': 112, 'step': 1, 'end': 130}]
          fields:
#            - { field: conductivity, interpolation: P1_average }
#            - piezo_head_p0
            - conductivity
            - pressure_p0
            - velocity_p0
            - region_id
          observe_fields: [pressure_p0, conductivity]
        output_stream:
          file: flow.pvd
          format: !vtk
#          observe_points: &observe_points
#            - { name: V1, point: [ 0, 3.25, 0 ] }  # HGT1-5: 3.5/2 + 1.5
#            - { name: V2, point: [ 0, 5.75, 0 ] }  # HGT1-4: 3.5/2 + 4
#            - { name: H1, point: [ 3.6875, 0, 0 ] }  # HGT2-4: 4.375/2 + 1.5
#            - { name: H2, point: [ 6.1875, 0, 0 ] }  # HGT2-3: 4.375/2 + 4
#            - { name: V01_cond, point: [ 0, 1.75, 0 ] }  # : 3.5/2
#            - { name: V02_cond, point: [ 0, 2.15, 0 ] }  # : 3.5/2 + 0.4
#            - { name: H01_cond, point: [ 2.1875, 0, 0 ] }  # : 4.375/2
#            - { name: H02_cond, point: [ 2.7875, 0, 0 ] }  # : 4.375/2 + 0.6
    mechanics_equation:
        user_fields:
          - name: a
            scalar_field: !FieldFormula # uhel mezi osou rozrazky a hlavnim napetim
              value: 117*pi/180
          - name: sx # initial stress in x direction (orthogonal to tunnel axis)
            scalar_field: !FieldFormula
              value: 42e6*cos(a)**2 + 19e6*sin(a)**2
          - name: sxy
            scalar_field: !FieldFormula
              value: cos(a)*sin(a)*(19e6-42e6)
          - name: sy
            scalar_field: !FieldFormula
              value: 19e6*cos(a)**2 + 42e6*sin(a)**2
          - name: sz
            scalar_field: 14e6

        output_stream:
          file: mechanics.pvd
          format: !vtk
#          observe_points: *observe_points
        output:
          times: *output_times
          fields:
#            - { field: displacement, interpolation: P1_average }
            - displacement
            - stress
#            - displacement_divergence
#            - mean_stress
#            - von_mises_stress
#            - initial_stress
            - region_id
          observe_fields: [von_mises_stress]
        solver: !Petsc
          a_tol: 0
          r_tol: 1e-12
          options: -ksp_type cg -pc_type hypre -pc_hypre_type boomeramg
        input_fields:
          - region: BULK
            young_modulus: 60e9
            poisson_ratio: 0.23
            initial_stress: !FieldFormula
              value: [ [-sx, -sxy, 0], [-sxy, -sy, 0], [0, 0, -sz] ]

          - region: .box_outer
            bc_type: displacement_n
            bc_displacement: 0

          # bc_type stress prepocita tenzor napeti na normalovou silu, s normalou orientovanou dovnitr
          # bc_stress * vnitřní normála = bc_traction = síla působící na těleso
          - region: .box_tunnel
            time: 0
            bc_type: stress
            bc_stress: !FieldFormula
              value: [ ["if((-x>2) | (x>2),0,-sx)", "if((-x>2) | (x>2),0,-sxy)", 0], ["if((-x>2) | (x>2),0,-sxy)", "if((-x>2) | (x>2),0,-sy)", 0], [0, 0, -sz] ]
          - region: .box_tunnel
            time: 100
            bc_type: stress
            bc_stress: !FieldFormula
              value: [ ["if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),0,-sx)", "if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),0,-sxy)", 0],
                       ["if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),0,-sxy)", "if((-x>2+2*(t/86400-100)) | (x>2+2*max(0,t/86400-107)),0,-sy)", 0],
                       [0, 0, -sz] ]
#          - region: .box_tunnel
#            time: 112
#            bc_type: stress
#            bc_stress: !FieldFormula
#              value: [ -sx, -sy, -sz]
